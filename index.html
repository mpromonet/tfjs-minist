<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script>
    <script>
    async function start() {
	const model = await tf.loadLayersModel('mnistjs/model.json');
	model.summary()

	var input = document.getElementById('input');
	var ctx = input.getContext('2d');

	// last known position
	var pos = { x: 0, y: 0 };

	document.addEventListener('mousemove', draw);
	document.addEventListener('mousedown', setPosition);
	document.addEventListener('mouseenter', setPosition);

	// new position from mouse event
	function setPosition(e) {
	  pos.x = e.clientX;
	  pos.y = e.clientY;
	}

	function draw(e) {
	  // mouse left button must be pressed
	  if (e.buttons !== 1) return;

	  ctx.beginPath(); // begin

	  ctx.lineWidth = 5;
	  ctx.lineCap = 'round';
	  ctx.strokeStyle = 'black';

	  ctx.moveTo(pos.x, pos.y); // from
	  setPosition(e);
	  ctx.lineTo(pos.x, pos.y); // to

	  ctx.stroke(); // draw it!
	}

	var canvas = document.createElement('canvas')
	canvas.width = 28;
	canvas.height = 28;

	var prediction = document.getElementById('prediction')
	var result = document.getElementById('result')

	function detect(model, input) {
		const ctx = canvas.getContext('2d');
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx.drawImage(input, 0, 0, input.width, input.height, 0, 0, canvas.width, canvas.height);		
		
		let img = tf.browser.fromPixels(canvas,4).mean(2).expandDims(0).expandDims(-1);
		const predict = model.predict(img);

		const rpredict = tf.round(predict.mul(10));
		prediction.innerHTML = rpredict.dataSync();
		result.innerHTML = predict.argMax(1).dataSync()[0];
		
		window.setTimeout( ()=>{ detect(model, input); } , 1000 );
	}
	
	detect(model,input);
    }
    start();
    </script>
 </head>
<body>
<canvas id="input" width="100" height="100"></canvas>
<div id="prediction"></div>
<div id="result"></div>
</body>
</html>
